!function(e){"use strict";function t(e,t){return t={exports:{}},e(t,t.exports),t.exports}e="default"in e?e.default:e,!function(e){e="default"in e?e.default:e;var t={};t.classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},t.createClass=function(){function e(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,a,n){return a&&e(t.prototype,a),n&&e(t,n),t}}();var a=function(e,t){var a=function(e){var t={key:e,isOptional:!1},a=e.split("?");return""===a[0]&&(t.key=a[1],t.isOptional=!0),t};return e.split(t).map(a)},n=function(){function e(a){t.classCallCheck(this,e);try{this.separator=a.get("ngSmartIdSeparator")}catch(e){this.separator=":"}try{this.patterns=a.get("ngSmartIdPatterns")}catch(e){this.patterns={}}}return t.createClass(e,[{key:"parse",value:function(e,t){var n=e.split(this.separator),i=void 0,r=n.reduce(function(e,t){return i?(e[i]=t,i=void 0):i=t,e},{});if(t){t=this.patterns[t]||t;var s=a(t,this.separator);s.forEach(function(e){if(!r[e.key]&&!e.isOptional)throw new Error("could not parse the id, non optional field "+e.key+" missing")})}return r}},{key:"idify",value:function(e,t){var n=this,i=function(e){return"undefined"!=typeof e&&null!==e&&""!==e};t=this.patterns[t]||t;var r=a(t,this.separator);return r.reduce(function(t,a){var r=e[a.key];if(r&&i(r))return t+(t.length?n.separator+a.key:a.key)+n.separator+r;if(!a.isOptional)throw new Error("could not generate id, missing field "+a.key);return t},"")}}]),e}();n.$inject=["$injector"],e.module("ngSmartId",[]).service("smartId",n)}(angular);var a=(t(function(e,t){"undefined"!=typeof e&&"undefined"!=typeof t&&e.exports===t&&(e.exports="pouchdb"),function(e,t,a){t.module("pouchdb",[]).constant("POUCHDB_METHODS",{destroy:"qify",put:"qify",post:"qify",get:"qify",remove:"qify",bulkDocs:"qify",bulkGet:"qify",allDocs:"qify",putAttachment:"qify",getAttachment:"qify",removeAttachment:"qify",query:"qify",viewCleanup:"qify",info:"qify",compact:"qify",revsDiff:"qify",changes:"eventEmitter",sync:"eventEmitter",replicate:{to:"eventEmitter",from:"eventEmitter"}}).service("pouchDBDecorators",["$q",function(e){this.qify=function(t){return function(){return e.when(t.apply(this,arguments))}},this.eventEmitter=function(t){return function(){var a=e.defer(),n=t.apply(this,arguments).on("change",function(e){return a.notify({change:e})}).on("paused",function(e){return a.notify({paused:e})}).on("active",function(e){return a.notify({active:e})}).on("denied",function(e){return a.notify({denied:e})}).on("complete",function(e){return a.resolve(e)}).on("error",function(e){return a.reject(e)});return n.$promise=a.promise,n}}}]).provider("pouchDB",["POUCHDB_METHODS",function(e){var a=this;a.methods=e,a.$get=["$window","pouchDBDecorators",function(e,n){function i(e,a,r){for(var s in a){var c=a[s];t.isString(c)?(c=n[c],r?e[r][s]=c(e[r][s]):e[s]=c(e[s])):i(e,c,s)}return e}return function(t,n){var r=new e.PouchDB(t,n);return i(r,a.methods)}}]}])}(window,window.angular)}),function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}),n=function(){function e(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,a,n){return a&&e(t.prototype,a),n&&e(t,n),t}}(),i=function(e,t){e.then(t)},r=function(){function e(t,n,i){a(this,e);var r=void 0;try{r=t.get("dataModuleRemoteDB")}catch(e){throw new Error("dataModuleRemoteDB should be provided in the data module configuration")}this.pouchDB=n,this.angularNavDataUtilsService=i,this.remoteDB=this.pouchDB(r),this.replicationFrom,this.localDB,this.registeredOnReplicationCompleteCallbackIds=[],this.callbacksPendingRegistration=[]}return n(e,[{key:"startReplication",value:function(e,t){var a={filter:"locations/by-level",query_params:{zone:e}};for(t&&(a.query_params.state=t),this.localDB=this.pouchDB("navIntLocationsDB"),this.replicationFrom=this.localDB.replicate.from(this.remoteDB,a);this.callbacksPendingRegistration.length;){var n=this.callbacksPendingRegistration.shift();i(this.replicationFrom,n)}}},{key:"callOnReplicationComplete",value:function(e,t){this.registeredOnReplicationCompleteCallbackIds.indexOf(e)===-1&&(this.registeredOnReplicationCompleteCallbackIds.push(e),this.replicationFrom?i(this.replicationFrom,t):this.callbacksPendingRegistration.push(t))}},{key:"allDocs",value:function(e){var t=this.localDB||this.remoteDB;return this.angularNavDataUtilsService.allDocs(t,e)}},{key:"query",value:function(e,t){var a=this.localDB||this.remoteDB;return this.angularNavDataUtilsService.query(a,e,t)}},{key:"get",value:function(e){var t=this.localDB||this.remoteDB;return t.get(e)}}]),e}();r.$inject=["$injector","pouchDB","angularNavDataUtilsService"];var s=function(){function e(t,n,i,r,s,c){a(this,e),this.cachedLgasByState={},this.defaultZone,this.defaultState,this.registeredOnCacheUpdatedCallbacks={},this.$q=t,this.smartId=n,this.locationsService=i,this.statesService=r,this.productListService=s,this.utils=c;var o=this.bustCache.bind(this);this.locationsService.callOnReplicationComplete("lgas-service",o)}return n(e,[{key:"registerOnCacheUpdatedCallback",value:function(e,t){this.registeredOnCacheUpdatedCallbacks[e]||(this.registeredOnCacheUpdatedCallbacks[e]=t)}},{key:"unregisterOnCacheUpdatedCallback",value:function(e){delete this.registeredOnCacheUpdatedCallbacks[e]}},{key:"bustCache",value:function(){this.byState({bustCache:!0}),this.setDefaultStateRelevantProducts()}},{key:"setDefaultStateRelevantProducts",value:function(){var e=this,t=function(t){e.productListService.setRelevant(t.products)},a="configuration:"+this.smartId.idify({zone:this.defaultZone,state:this.defaultState},"zone:state");this.locationsService.get(a).then(t)}},{key:"queryAndUpdateCache",value:function(e){var t=this,a=function(e){return e.id=t.smartId.parse(e._id).lga,e},n=function(e){var a={include_docs:!0,ascending:!0};return e.zone&&e.state?(a.startkey="zone:"+e.zone+":state:"+e.state+":",a.endkey="zone:"+e.zone+":state:"+e.state+":￿",t.locationsService.allDocs(a)):(a.key="lga",t.locationsService.query("locations/by-level",a))},i=function(e,n){var i=n.map(a);e?t.cachedLgasByState[e]=i:t.cachedLgasByState=i,t.utils.isIndexedCacheEmpty(t.cachedLgasByState,e)||t.utils.callEach(t.registeredOnCacheUpdatedCallbacks)};return n(e).then(i.bind(null,e.state))}},{key:"byState",value:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],a=function(e){return e.id},n=function(){var n=angular.copy(e.cachedLgasByState);return t.onlyIds&&Object.keys(n).forEach(function(e){n[e]=n[e].map(a)}),t.zone&&t.state&&(n=n[t.state]),t.asArray&&(n=e.utils.toArray(n)),n};return t.zone=t.zone||this.defaultZone,t.state=t.state||this.defaultState,t.bustCache||this.utils.isIndexedCacheEmpty(this.cachedLgasByState,t.state)?this.queryAndUpdateCache(t).then(n):this.$q.when(n())}},{key:"idsByState",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return e.onlyIds=!0,this.byState(e)}},{key:"list",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return e.asArray=!0,this.byState(e)}},{key:"setState",value:function(e,t){this.defaultZone=e,this.defaultState=t,this.statesService.setZone(this.defaultZone),this.bustCache()}},{key:"get",value:function(e){var t=function(t){var a=!0,n=!1,i=void 0;try{for(var r,s=t[Symbol.iterator]();!(a=(r=s.next()).done);a=!0){var c=r.value;if(c._id===e)return c}}catch(e){n=!0,i=e}finally{try{!a&&s.return&&s.return()}finally{if(n)throw i}}},a=this.smartId.parse(e).state,n=this.smartId.parse(e).zone;return this.byState({zone:n,state:a}).then(t)}}]),e}();s.$inject=["$q","smartId","locationsService","statesService","productListService","angularNavDataUtilsService"];var c=function(){function e(t,n,i,r){a(this,e),this.cachedStatesByZone={},this.defaultZone,this.registeredOnCacheUpdatedCallbacks={},this.$q=t,this.smartId=n,this.locationsService=i,this.utils=r;var s=this.byZone.bind(this,{bustCache:!0});this.locationsService.callOnReplicationComplete("states-service",s)}return n(e,[{key:"registerOnCacheUpdatedCallback",value:function(e,t){this.registeredOnCacheUpdatedCallbacks[e]||(this.registeredOnCacheUpdatedCallbacks[e]=t)}},{key:"unregisterOnCacheUpdatedCallback",value:function(e){delete this.registeredOnCacheUpdatedCallbacks[e]}},{key:"queryAndUpdateCache",value:function(e){var t=this,a=function(e){return e.id=t.smartId.parse(e._id).state,e},n=function(e){var a={include_docs:!0,ascending:!0};return e.zone?(a.startkey="zone:"+e.zone+":",a.endkey="zone:"+e.zone+":￿",t.locationsService.allDocs(a)):(a.key="state",t.locationsService.query("locations/by-level",a))},i=function(e,n){var i=n.map(a);e?t.cachedStatesByZone[e]=i:t.cachedStatesByZone=i,t.utils.isIndexedCacheEmpty(t.cachedStatesByZone,e)||t.utils.callEach(t.registeredOnCacheUpdatedCallbacks)};return n(e).then(i.bind(null,e.zone))}},{key:"byZone",value:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],a=function(e){return e.id},n=function(){var n=angular.copy(e.cachedStatesByZone);return t.onlyIds&&Object.keys(n).forEach(function(e){n[e]=n[e].map(a)}),t.zone&&(n=n[t.zone]),t.asArray&&(n=e.utils.toArray(n)),n};return t.zone=t.zone||this.defaultZone,t.bustCache||this.utils.isIndexedCacheEmpty(this.cachedStatesByZone,t.zone)?this.queryAndUpdateCache(t).then(n):this.$q.when(n())}},{key:"idsByZone",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return e.onlyIds=!0,this.byZone(e)}},{key:"list",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return e.asArray=!0,this.byZone(e)}},{key:"setZone",value:function(e){this.defaultZone=e,this.byZone({bustCache:!0})}},{key:"get",value:function(e){var t=function(t){var a=!0,n=!1,i=void 0;try{for(var r,s=t[Symbol.iterator]();!(a=(r=s.next()).done);a=!0){var c=r.value;if(c._id===e)return c}}catch(e){n=!0,i=e}finally{try{!a&&s.return&&s.return()}finally{if(n)throw i}}},a=this.smartId.parse(e).zone;return this.byZone({zone:a}).then(t)}}]),e}();c.$inject=["$q","smartId","locationsService","angularNavDataUtilsService"];var o=function(e){return e.doc},l=function(e){return"undefined"!=typeof e},u=function(e){return e.rows.map(o).filter(l)},h=function(){function e(){a(this,e)}return n(e,[{key:"allDocs",value:function(e,t){return e.allDocs(t).then(u)}},{key:"query",value:function(e,t,a){return e.query(t,a).then(u)}},{key:"callEach",value:function(e){var t=function(t){return e[t]()};Object.keys(e).forEach(t)}},{key:"isEmptyObject",value:function(e){return!Object.keys(e).length}},{key:"isIndexedCacheEmpty",value:function(e,t){var a=this.isEmptyObject(e);return!a&&t?!e[t]||!e[t].length:a}},{key:"toArray",value:function(e){return Object.keys(e).reduce(function(t,a){return t.concat(e[a])},[])}}]),e}(),d="angularNavData.utils";e.module(d,[]).service("angularNavDataUtilsService",h);var v="angularNavData.locations";e.module(v,[d,"ngSmartId","pouchdb"]).service("locationsService",r).service("lgasService",s).service("statesService",c);var f=function(e,t){e.then(t)},y=function(){function e(t,n,i){a(this,e);var r=void 0;try{r=t.get("dataModuleRemoteDB")}catch(e){throw new Error("dataModuleRemoteDB should be provided in the data module configuration")}this.pouchDB=n,this.angularNavDataUtilsService=i,this.remoteDB=this.pouchDB(r),this.replicationFrom,this.localDB,this.registeredOnReplicationCompleteCallbackIds=[],this.callbacksPendingRegistration=[]}return n(e,[{key:"startReplication",value:function(e,t){var a={filter:"products/all"};for(this.localDB=this.pouchDB("navIntProductsDB"),this.replicationFrom=this.localDB.replicate.from(this.remoteDB,a);this.callbacksPendingRegistration.length;){var n=this.callbacksPendingRegistration.shift();f(this.replicationFrom,n)}}},{key:"callOnReplicationComplete",value:function(e,t){this.registeredOnReplicationCompleteCallbackIds.indexOf(e)===-1&&(this.registeredOnReplicationCompleteCallbackIds.push(e),this.replicationFrom?f(this.replicationFrom,t):this.callbacksPendingRegistration.push(t))}},{key:"allDocs",value:function(e){var t=this.localDB||this.remoteDB;return this.angularNavDataUtilsService.allDocs(t,e)}}]),e}();y.$inject=["$injector","pouchDB","angularNavDataUtilsService"];var p=function(){function e(t,n,i){a(this,e),this.cachedProducts=[],this.relevantIds=[],this.registeredOnCacheUpdatedCallbacks={},this.$q=t,this.productsService=n,this.utils=i;var r=this.relevant.bind(this,{bustCache:!0});this.productsService.callOnReplicationComplete("products-list-service",r)}return n(e,[{key:"registerOnCacheUpdatedCallback",value:function(e,t){this.registeredOnCacheUpdatedCallbacks[e]||(this.registeredOnCacheUpdatedCallbacks[e]=t)}},{key:"unregisterOnCacheUpdatedCallback",value:function(e){delete this.registeredOnCacheUpdatedCallbacks[e]}},{key:"queryAndUpdateCache",value:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],a=function(t){var a={include_docs:!0};if(t.onlyRelevant){if(!e.relevantIds.length)return e.$q.when([]);a.keys=e.relevantIds}else a.ascending=!0,a.startkey="product:",a.endkey="product:￿";return e.productsService.allDocs(a)},n=function(t){e.cachedProducts=t,e.cachedProducts.length&&e.utils.callEach(e.registeredOnCacheUpdatedCallbacks)};return a(t).then(n)}},{key:"relevant",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return e.onlyRelevant=!0,this.all(e)}},{key:"all",value:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],a=function(e,t){return t.storageType===e},n=function(){return t.byType?{dry:e.cachedProducts.filter(a.bind(null,"dry")),frozen:e.cachedProducts.filter(a.bind(null,"frozen"))}:e.cachedProducts};return this.cachedProducts.length&&!t.bustCache?this.$q.when(n()):this.queryAndUpdateCache(t).then(n)}},{key:"setRelevant",value:function(e){this.relevantIds=e,this.relevant({bustCache:!0})}}]),e}();p.$inject=["$q","productsService","angularNavDataUtilsService"];var g="angularNavData.products";e.module(g,[d,"pouchdb"]).service("productsService",y).service("productListService",p),e.module("angularNavData",[v,g])}(angular);