!function(t){"use strict";function e(t,e){return e={exports:{}},t(e,e.exports),e.exports}t="default"in t?t["default"]:t,!function(t){t="default"in t?t["default"]:t;var e={};e.classCallCheck=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},e.createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}();var n=function(t,e){var n=function(t){var e={key:t,isOptional:!1},n=t.split("?");return""===n[0]&&(e.key=n[1],e.isOptional=!0),e};return t.split(e).map(n)},i=function(){function t(n){e.classCallCheck(this,t);try{this.separator=n.get("ngSmartIdSeparator")}catch(i){this.separator=":"}try{this.patterns=n.get("ngSmartIdPatterns")}catch(i){this.patterns={}}}return e.createClass(t,[{key:"parse",value:function(t,e){var i=t.split(this.separator),a=void 0,r=i.reduce(function(t,e){return a?(t[a]=e,a=void 0):a=e,t},{});if(e){e=this.patterns[e]||e;var o=n(e,this.separator);o.forEach(function(t){if(!r[t.key]&&!t.isOptional)throw new Error("could not parse the id, non optional field "+t.key+" missing")})}return r}},{key:"idify",value:function(t,e){var i=this,a=function(t){return"undefined"!=typeof t&&null!==t&&""!==t};e=this.patterns[e]||e;var r=n(e,this.separator);return r.reduce(function(e,n){var r=t[n.key];if(r&&a(r))return e+(e.length?i.separator+n.key:n.key)+i.separator+r;if(!n.isOptional)throw new Error("could not generate id, missing field "+n.key);return e},"")}}]),t}();i.$inject=["$injector"],t.module("ngSmartId",[]).service("smartId",i)}(angular);var n=(e(function(t,e){"undefined"!=typeof t&&"undefined"!=typeof e&&t.exports===e&&(t.exports="pouchdb"),function(t,e,n){e.module("pouchdb",[]).constant("POUCHDB_METHODS",{destroy:"qify",put:"qify",post:"qify",get:"qify",remove:"qify",bulkDocs:"qify",bulkGet:"qify",allDocs:"qify",putAttachment:"qify",getAttachment:"qify",removeAttachment:"qify",query:"qify",viewCleanup:"qify",info:"qify",compact:"qify",revsDiff:"qify",changes:"eventEmitter",sync:"eventEmitter",replicate:{to:"eventEmitter",from:"eventEmitter"}}).service("pouchDBDecorators",["$q",function(t){this.qify=function(e){return function(){return t.when(e.apply(this,arguments))}},this.eventEmitter=function(e){return function(){var n=t.defer(),i=e.apply(this,arguments).on("change",function(t){return n.notify({change:t})}).on("paused",function(t){return n.notify({paused:t})}).on("active",function(t){return n.notify({active:t})}).on("denied",function(t){return n.notify({denied:t})}).on("complete",function(t){return n.resolve(t)}).on("error",function(t){return n.reject(t)});return i.$promise=n.promise,i}}}]).provider("pouchDB",["POUCHDB_METHODS",function(t){var n=this;n.methods=t,n.$get=["$window","pouchDBDecorators",function(t,i){function a(t,n,r){for(var o in n){var c=n[o];e.isString(c)?(c=i[c],r?t[r][o]=c(t[r][o]):t[o]=c(t[o])):a(t,c,o)}return t}return function(e,i){var r=new t.PouchDB(e,i);return a(r,n.methods)}}]}])}(window,window.angular)}),function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}),i=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),a=function(t,e){t.then(e)},r=function(){function t(e,i,a){n(this,t);var r=void 0;try{r=e.get("dataModuleRemoteDB")}catch(o){throw new Error("dataModuleRemoteDB should be provided in the data module configuration")}this.pouchDB=i,this.angularNavDataUtilsService=a,this.remoteDB=this.pouchDB(r),this.replicationFrom,this.localDB,this.registeredOnReplicationCompleteCallbackIds=[],this.callbacksPendingRegistration=[]}return i(t,[{key:"startReplication",value:function(t,e){var n={filter:"locations/by-state",query_params:{zone:t,state:e}};for(this.localDB=this.pouchDB("navIntLocationsDB"),this.replicationFrom=this.localDB.replicate.from(this.remoteDB,n);this.callbacksPendingRegistration.length;){var i=this.callbacksPendingRegistration.shift();a(this.replicationFrom,i)}}},{key:"callOnReplicationComplete",value:function(t,e){-1===this.registeredOnReplicationCompleteCallbackIds.indexOf(t)&&(this.registeredOnReplicationCompleteCallbackIds.push(t),this.replicationFrom?a(this.replicationFrom,e):this.callbacksPendingRegistration.push(e))}},{key:"allDocs",value:function(t){var e=this.localDB||this.remoteDB;return this.angularNavDataUtilsService.allDocs(e,t)}},{key:"get",value:function(t){var e=this.localDB||this.remoteDB;return e.get(t)}}]),t}();r.$inject=["$injector","pouchDB","angularNavDataUtilsService"];var o=function(){function t(e,i,a,r,o){n(this,t),this.cachedLgasByState={},this.cachedLgaIdsByState={},this.defaultZone,this.defaultState,this.$q=e,this.smartId=i,this.locationsService=a,this.statesService=r,this.productListService=o,this.locationsService.callOnReplicationComplete("lgas-service",this.onReplicationComplete.bind(this))}return i(t,[{key:"queryAndUpdateCache",value:function(t,e){var n=this,i=function(t){return t.id},a=function(t){return t.id=n.smartId.parse(t._id).lga,t},r=function(t,e){var i={include_docs:!0,ascending:!0,startkey:"zone:"+t+":state:"+e+":",endkey:"zone:"+t+":state:"+e+":￿"};return n.locationsService.allDocs(i)},o=function(t,e){n.cachedLgasByState[t]=e.map(a),n.cachedLgaIdsByState[t]=n.cachedLgasByState[t].map(i)};return r(t,e).then(o.bind(null,e))}},{key:"configDefaultState",value:function(t,e){var n=this,i=function(t){console.log("got config",t),n.productListService.setRelevant(t.products)};t=t||this.defaultZone,e=e||this.defaultState,console.log("setState",e);var a="configuration:zone:"+t+":state:"+e;this.locationsService.get(a).then(i)}},{key:"byState",value:function(t,e){return t=t||this.defaultZone,e=e||this.defaultState,this.cachedLgasByState[e]?this.$q.when(this.cachedLgasByState[e]):this.queryAndUpdateCache(t,e).then(function(){return this.cachedLgasByState[e]}.bind(this))}},{key:"idsByState",value:function(t,e){return t=t||this.defaultZone,e=e||this.defaultState,this.cachedLgasByState[e]?this.$q.when(this.cachedLgaIdsByState[e]):this.queryAndUpdateCache(t,e).then(function(){return this.cachedLgaIdsByState[e]}.bind(this))}},{key:"setState",value:function(t,e){this.defaultZone=t,this.defaultState=e,this.statesService.setZone(this.defaultZone),this.byState(),this.configDefaultState()}},{key:"onReplicationComplete",value:function(){this.byState(),this.configDefaultState()}},{key:"get",value:function(t){var e=function(e){var n=!0,i=!1,a=void 0;try{for(var r,o=e[Symbol.iterator]();!(n=(r=o.next()).done);n=!0){var c=r.value;if(c._id===t)return c}}catch(s){i=!0,a=s}finally{try{!n&&o["return"]&&o["return"]()}finally{if(i)throw a}}},n=this.smartId.parse(t).state,i=this.smartId.parse(t).zone;return this.byState(i,n).then(e)}}]),t}();o.$inject=["$q","smartId","locationsService","statesService","productListService"];var c=function(){function t(e,i,a){n(this,t),this.cachedStatesByZone={},this.cachedStateIdsByZone={},this.defaultZone,this.$q=e,this.smartId=i,this.locationsService=a,this.locationsService.callOnReplicationComplete("states-service",this.byZone.bind(this))}return i(t,[{key:"queryAndUpdateCache",value:function(t){var e=this,n=function(t){return t.id},i=function(t){return t.id=e.smartId.parse(t._id).state,t},a=function(t){return t.filter(function(t){return"state"===t.level})},r=function(t){var n={include_docs:!0,ascending:!0,startkey:"zone:"+t+":",endkey:"zone:"+t+":￿"};return e.locationsService.allDocs(n).then(a)},o=function(t,a){e.cachedStatesByZone[t]=a.map(i),e.cachedStateIdsByZone[t]=e.cachedStatesByZone[t].map(n)};return r(t).then(o.bind(null,t))}},{key:"byZone",value:function(t){return t=t||this.defaultZone,this.cachedStatesByZone[t]?this.$q.when(this.cachedStatesByZone[t]):this.queryAndUpdateCache(t).then(function(){return this.cachedStatesByZone[t]}.bind(this))}},{key:"idsByZone",value:function(t){return t=t||this.defaultZone,this.cachedStatesByZone[t]?this.$q.when(this.cachedStateIdsByZone[t]):this.queryAndUpdateCache(t).then(function(){return this.cachedStateIdsByZone[t]}.bind(this))}},{key:"setZone",value:function(t){this.defaultZone=t,this.byZone()}},{key:"get",value:function(t){var e=function(e){var n=!0,i=!1,a=void 0;try{for(var r,o=e[Symbol.iterator]();!(n=(r=o.next()).done);n=!0){var c=r.value;if(c._id===t)return c}}catch(s){i=!0,a=s}finally{try{!n&&o["return"]&&o["return"]()}finally{if(i)throw a}}},n=this.smartId.parse(t).zone;return this.byZone(n).then(e)}}]),t}();c.$inject=["$q","smartId","locationsService"];var s=function(t){return t.doc},u=function(t){return t.rows.map(s)},l=function(){function t(){n(this,t)}return i(t,[{key:"allDocs",value:function(t,e){return t.allDocs(e).then(u)}}]),t}(),h="angularNavData.utils";t.module(h,[]).service("angularNavDataUtilsService",l);var d="angularNavData.locations";t.module(d,[h,"ngSmartId","pouchdb"]).service("locationsService",r).service("lgasService",o).service("statesService",c);var f=function(t,e){t.then(e)},v=function(){function t(e,i,a){n(this,t);var r=void 0;try{r=e.get("dataModuleRemoteDB")}catch(o){throw new Error("dataModuleRemoteDB should be provided in the data module configuration")}this.pouchDB=i,this.angularNavDataUtilsService=a,this.remoteDB=this.pouchDB(r),this.replicationFrom,this.localDB,this.registeredOnReplicationCompleteCallbackIds=[],this.callbacksPendingRegistration=[]}return i(t,[{key:"startReplication",value:function(t,e){var n={filter:"products/all"};for(this.localDB=this.pouchDB("navIntProductsDB"),this.replicationFrom=this.localDB.replicate.from(this.remoteDB,n);this.callbacksPendingRegistration.length;){var i=this.callbacksPendingRegistration.shift();f(this.replicationFrom,i)}}},{key:"callOnReplicationComplete",value:function(t,e){-1===this.registeredOnReplicationCompleteCallbackIds.indexOf(t)&&(this.registeredOnReplicationCompleteCallbackIds.push(t),this.replicationFrom?f(this.replicationFrom,e):this.callbacksPendingRegistration.push(e))}},{key:"allDocs",value:function(t){var e=this.localDB||this.remoteDB;return this.angularNavDataUtilsService.allDocs(e,t)}}]),t}();v.$inject=["$injector","pouchDB","angularNavDataUtilsService"];var y=function(){function t(e,i){n(this,t),this.cachedProducts=[],this.cachedDryProducts=[],this.cachedFrozenProducts=[],this.relevant=[],this.$q=e,this.productsService=i,this.productsService.callOnReplicationComplete("products-list-service",this.all.bind(this,{onlyRelevant:!0}))}return i(t,[{key:"invalidateCaches",value:function(){this.cachedProducts=[],this.cachedDryProducts=[],this.cachedFrozenProducts=[]}},{key:"queryAndUpdateCache",value:function(t){var e=this,n=function(t){var n={include_docs:!0};if(console.log("querying",e),console.log("querying with options",t),t.onlyRelevant){if(console.log("relevant"),!e.relevant.length)return console.log("not yet ready, will repeat"),e.$q.reject();n.keys=e.relevant}else console.log("not only relevant"),n.ascending=!0,n.startkey="product:",n.endkey="product:￿";return console.log("query options",n),e.productsService.allDocs(n)},i=function(t){return"dry"===t.storageType},a=function(t){return"frozen"===t.storageType},r=function(t){return"undefined"!=typeof t},o=function(t){console.log("updatingCaches",t),e.cachedProducts=t.filter(r),e.cachedDryProducts=e.cachedProducts.filter(i),e.cachedFrozenProducts=e.cachedProducts.filter(a)};return t=t||{},n(t).then(o)}},{key:"all",value:function(t){return console.log("querying all",this.cachedProducts),console.log("all with options",t),!this.cachedProducts.length>0?this.queryAndUpdateCache(t).then(function(){return this.cachedProducts}.bind(this)):(console.log("returning all cached"),this.$q.when(this.cachedProducts))}},{key:"dry",value:function(t){return console.log("querying dry",this.cachedDryProducts),console.log("dry with options",t),!this.cachedDryProducts.length>0?this.queryAndUpdateCache(t).then(function(){return this.cachedDryProducts}.bind(this)):(console.log("returning dry cached"),this.$q.when(this.cachedDryProducts))}},{key:"frozen",value:function(t){return console.log("querying frozen",this.cachedFrozenProducts),console.log("frozen with options",t),!this.cachedFrozenProducts.length>0?this.queryAndUpdateCache(t).then(function(){return this.cachedFrozenProducts}.bind(this)):(console.log("returning frozen cached"),this.$q.when(this.cachedFrozenProducts))}},{key:"setRelevant",value:function(t){console.log("setting relevant",t),this.relevant=t,this.invalidateCaches(),this.queryAndUpdateCache({onlyRelevant:!0})}}]),t}();y.$inject=["$q","productsService"];var p="angularNavData.products";t.module(p,[h,"pouchdb"]).service("productsService",v).service("productListService",y),t.module("angularNavData",[d,p])}(angular);