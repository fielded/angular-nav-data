!function(e){"use strict";function t(e,t){return t={exports:{}},e(t,t.exports),t.exports}e="default"in e?e["default"]:e,!function(e){e="default"in e?e["default"]:e;var t={};t.classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},t.createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}();var n=function(e,t){var n=function(e){var t={key:e,isOptional:!1},n=e.split("?");return""===n[0]&&(t.key=n[1],t.isOptional=!0),t};return e.split(t).map(n)},a=function(){function e(n){t.classCallCheck(this,e);try{this.separator=n.get("ngSmartIdSeparator")}catch(a){this.separator=":"}try{this.patterns=n.get("ngSmartIdPatterns")}catch(a){this.patterns={}}}return t.createClass(e,[{key:"parse",value:function(e,t){var a=e.split(this.separator),i=void 0,r=a.reduce(function(e,t){return i?(e[i]=t,i=void 0):i=t,e},{});if(t){t=this.patterns[t]||t;var s=n(t,this.separator);s.forEach(function(e){if(!r[e.key]&&!e.isOptional)throw new Error("could not parse the id, non optional field "+e.key+" missing")})}return r}},{key:"idify",value:function(e,t){var a=this,i=function(e){return"undefined"!=typeof e&&null!==e&&""!==e};t=this.patterns[t]||t;var r=n(t,this.separator);return r.reduce(function(t,n){var r=e[n.key];if(r&&i(r))return t+(t.length?a.separator+n.key:n.key)+a.separator+r;if(!n.isOptional)throw new Error("could not generate id, missing field "+n.key);return t},"")}}]),e}();a.$inject=["$injector"],e.module("ngSmartId",[]).service("smartId",a)}(angular);var n=(t(function(e,t){"undefined"!=typeof e&&"undefined"!=typeof t&&e.exports===t&&(e.exports="pouchdb"),function(e,t,n){t.module("pouchdb",[]).constant("POUCHDB_METHODS",{destroy:"qify",put:"qify",post:"qify",get:"qify",remove:"qify",bulkDocs:"qify",bulkGet:"qify",allDocs:"qify",putAttachment:"qify",getAttachment:"qify",removeAttachment:"qify",query:"qify",viewCleanup:"qify",info:"qify",compact:"qify",revsDiff:"qify",changes:"eventEmitter",sync:"eventEmitter",replicate:{to:"eventEmitter",from:"eventEmitter"}}).service("pouchDBDecorators",["$q",function(e){this.qify=function(t){return function(){return e.when(t.apply(this,arguments))}},this.eventEmitter=function(t){return function(){var n=e.defer(),a=t.apply(this,arguments).on("change",function(e){return n.notify({change:e})}).on("paused",function(e){return n.notify({paused:e})}).on("active",function(e){return n.notify({active:e})}).on("denied",function(e){return n.notify({denied:e})}).on("complete",function(e){return n.resolve(e)}).on("error",function(e){return n.reject(e)});return a.$promise=n.promise,a}}}]).provider("pouchDB",["POUCHDB_METHODS",function(e){var n=this;n.methods=e,n.$get=["$window","pouchDBDecorators",function(e,a){function i(e,n,r){for(var s in n){var c=n[s];t.isString(c)?(c=a[c],r?e[r][s]=c(e[r][s]):e[s]=c(e[s])):i(e,c,s)}return e}return function(t,a){var r=new e.PouchDB(t,a);return i(r,n.methods)}}]}])}(window,window.angular)}),function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}),a=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),i=function(e,t){e.then(t)},r=function(){function e(t,a,i){n(this,e);var r=void 0;try{r=t.get("dataModuleRemoteDB")}catch(s){throw new Error("dataModuleRemoteDB should be provided in the data module configuration")}this.pouchDB=a,this.angularNavDataUtilsService=i,this.remoteDB=this.pouchDB(r),this.replicationFrom,this.localDB,this.registeredOnReplicationCompleteCallbackIds=[],this.callbacksPendingRegistration=[]}return a(e,[{key:"startReplication",value:function(e,t){var n={filter:"locations/by-state",query_params:{zone:e,state:t}};for(this.localDB=this.pouchDB("navIntLocationsDB"),this.replicationFrom=this.localDB.replicate.from(this.remoteDB,n);this.callbacksPendingRegistration.length;){var a=this.callbacksPendingRegistration.shift();i(this.replicationFrom,a)}}},{key:"callOnReplicationComplete",value:function(e,t){-1===this.registeredOnReplicationCompleteCallbackIds.indexOf(e)&&(this.registeredOnReplicationCompleteCallbackIds.push(e),this.replicationFrom?i(this.replicationFrom,t):this.callbacksPendingRegistration.push(t))}},{key:"allDocs",value:function(e){var t=this.localDB||this.remoteDB;return this.angularNavDataUtilsService.allDocs(t,e)}},{key:"query",value:function(e,t){var n=this.localDB||this.remoteDB;return this.angularNavDataUtilsService.query(n,e,t)}},{key:"get",value:function(e){var t=this.localDB||this.remoteDB;return t.get(e)}}]),e}();r.$inject=["$injector","pouchDB","angularNavDataUtilsService"];var s=function(){function e(t,a,i,r,s,c){n(this,e),this.cachedLgasByState={},this.defaultZone,this.defaultState,this.registeredOnCacheUpdatedCallbacks={},this.$q=t,this.smartId=a,this.locationsService=i,this.statesService=r,this.productListService=s,this.utils=c;var o=this.bustCache.bind(this);this.locationsService.callOnReplicationComplete("lgas-service",o)}return a(e,[{key:"registerOnCacheUpdatedCallback",value:function(e,t){this.registeredOnCacheUpdatedCallbacks[e]||(this.registeredOnCacheUpdatedCallbacks[e]=t)}},{key:"unregisterOnCacheUpdatedCallback",value:function(e){delete this.registeredOnCacheUpdatedCallbacks[e]}},{key:"bustCache",value:function(){this.byState({bustCache:!0}),this.setDefaultStateRelevantProducts()}},{key:"setDefaultStateRelevantProducts",value:function(){var e=this,t=function(t){e.productListService.setRelevant(t.products)},n="configuration:"+this.smartId.idify({zone:this.defaultZone,state:this.defaultState},"zone:state");this.locationsService.get(n).then(t)}},{key:"queryAndUpdateCache",value:function(e){var t=this,n=function(e){return e.id=t.smartId.parse(e._id).lga,e},a=function(e){var n={include_docs:!0,ascending:!0};return e.zone&&e.state?(n.startkey="zone:"+e.zone+":state:"+e.state+":",n.endkey="zone:"+e.zone+":state:"+e.state+":￿",t.locationsService.allDocs(n)):(n.key="lga",t.locationsService.query("locations/by-level",n))},i=function(e,a){var i=a.map(n);e?t.cachedLgasByState[e]=i:t.cachedLgasByState=i,t.utils.isIndexedCacheEmpty(t.cachedLgasByState,e)||t.utils.callEach(t.registeredOnCacheUpdatedCallbacks)};return a(e).then(i.bind(null,e.state))}},{key:"byState",value:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=function(e){return e.id},a=function(){var a=angular.copy(e.cachedLgasByState);return t.onlyIds&&Object.keys(a).forEach(function(e){a[e]=a[e].map(n)}),t.zone&&t.state&&(a=a[t.state]),t.asArray&&(a=e.utils.toArray(a)),a};return t.zone=t.zone||this.defaultZone,t.state=t.state||this.defaultState,t.bustCache||this.utils.isIndexedCacheEmpty(this.cachedLgasByState,t.state)?this.queryAndUpdateCache(t).then(a):this.$q.when(a())}},{key:"idsByState",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return e.onlyIds=!0,this.byState(e)}},{key:"list",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return e.asArray=!0,this.byState(e)}},{key:"setState",value:function(e,t){this.defaultZone=e,this.defaultState=t,this.statesService.setZone(this.defaultZone),this.bustCache()}},{key:"get",value:function(e){var t=function(t){var n=!0,a=!1,i=void 0;try{for(var r,s=t[Symbol.iterator]();!(n=(r=s.next()).done);n=!0){var c=r.value;if(c._id===e)return c}}catch(o){a=!0,i=o}finally{try{!n&&s["return"]&&s["return"]()}finally{if(a)throw i}}},n=this.smartId.parse(e).state,a=this.smartId.parse(e).zone;return this.byState({zone:a,state:n}).then(t)}}]),e}();s.$inject=["$q","smartId","locationsService","statesService","productListService","angularNavDataUtilsService"];var c=function(){function e(t,a,i,r){n(this,e),this.cachedStatesByZone={},this.defaultZone,this.registeredOnCacheUpdatedCallbacks={},this.$q=t,this.smartId=a,this.locationsService=i,this.utils=r;var s=this.byZone.bind(this,{bustCache:!0});this.locationsService.callOnReplicationComplete("states-service",s)}return a(e,[{key:"registerOnCacheUpdatedCallback",value:function(e,t){this.registeredOnCacheUpdatedCallbacks[e]||(this.registeredOnCacheUpdatedCallbacks[e]=t)}},{key:"unregisterOnCacheUpdatedCallback",value:function(e){delete this.registeredOnCacheUpdatedCallbacks[e]}},{key:"queryAndUpdateCache",value:function(e){var t=this,n=function(e){return e.id=t.smartId.parse(e._id).state,e},a=function(e){var n={include_docs:!0,ascending:!0};return e.zone?(n.startkey="zone:"+e.zone+":",n.endkey="zone:"+e.zone+":￿",t.locationsService.allDocs(n)):(n.key="state",t.locationsService.query("locations/by-level",n))},i=function(e,a){var i=a.map(n);e?t.cachedStatesByZone[e]=i:t.cachedStatesByZone=i,t.utils.isIndexedCacheEmpty(t.cachedStatesByZone,e)||t.utils.callEach(t.registeredOnCacheUpdatedCallbacks)};return a(e).then(i.bind(null,e.zone))}},{key:"byZone",value:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=function(e){return e.id},a=function(){var a=angular.copy(e.cachedStatesByZone);return t.onlyIds&&Object.keys(a).forEach(function(e){a[e]=a[e].map(n)}),t.zone&&(a=a[t.zone]),t.asArray&&(a=e.utils.toArray(a)),a};return t.zone=t.zone||this.defaultZone,t.bustCache||this.utils.isIndexedCacheEmpty(this.cachedStatesByZone,t.zone)?this.queryAndUpdateCache(t).then(a):this.$q.when(a())}},{key:"idsByZone",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return e.onlyIds=!0,this.byZone(e)}},{key:"list",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return e.asArray=!0,this.byZone(e)}},{key:"setZone",value:function(e){this.defaultZone=e,this.byZone({bustCache:!0})}},{key:"get",value:function(e){var t=function(t){var n=!0,a=!1,i=void 0;try{for(var r,s=t[Symbol.iterator]();!(n=(r=s.next()).done);n=!0){var c=r.value;if(c._id===e)return c}}catch(o){a=!0,i=o}finally{try{!n&&s["return"]&&s["return"]()}finally{if(a)throw i}}},n=this.smartId.parse(e).zone;return this.byZone({zone:n}).then(t)}}]),e}();c.$inject=["$q","smartId","locationsService","angularNavDataUtilsService"];var o=function(e){return e.doc},l=function(e){return"undefined"!=typeof e},u=function(e){return e.rows.map(o).filter(l)},h=function(){function e(){n(this,e)}return a(e,[{key:"allDocs",value:function(e,t){return e.allDocs(t).then(u)}},{key:"query",value:function(e,t,n){return e.query(t,n).then(u)}},{key:"callEach",value:function(e){var t=function(t){return e[t]()};Object.keys(e).forEach(t)}},{key:"isEmptyObject",value:function(e){return!Object.keys(e).length}},{key:"isIndexedCacheEmpty",value:function(e,t){var n=this.isEmptyObject(e);return!n&&t?!e[t]||!e[t].length:n}},{key:"toArray",value:function(e){return Object.keys(e).reduce(function(t,n){return t.concat(e[n])},[])}}]),e}(),d="angularNavData.utils";e.module(d,[]).service("angularNavDataUtilsService",h);var v="angularNavData.locations";e.module(v,[d,"ngSmartId","pouchdb"]).service("locationsService",r).service("lgasService",s).service("statesService",c);var f=function(e,t){e.then(t)},y=function(){function e(t,a,i){n(this,e);var r=void 0;try{r=t.get("dataModuleRemoteDB")}catch(s){throw new Error("dataModuleRemoteDB should be provided in the data module configuration")}this.pouchDB=a,this.angularNavDataUtilsService=i,this.remoteDB=this.pouchDB(r),this.replicationFrom,this.localDB,this.registeredOnReplicationCompleteCallbackIds=[],this.callbacksPendingRegistration=[]}return a(e,[{key:"startReplication",value:function(e,t){var n={filter:"products/all"};for(this.localDB=this.pouchDB("navIntProductsDB"),this.replicationFrom=this.localDB.replicate.from(this.remoteDB,n);this.callbacksPendingRegistration.length;){var a=this.callbacksPendingRegistration.shift();f(this.replicationFrom,a)}}},{key:"callOnReplicationComplete",value:function(e,t){-1===this.registeredOnReplicationCompleteCallbackIds.indexOf(e)&&(this.registeredOnReplicationCompleteCallbackIds.push(e),this.replicationFrom?f(this.replicationFrom,t):this.callbacksPendingRegistration.push(t))}},{key:"allDocs",value:function(e){var t=this.localDB||this.remoteDB;return this.angularNavDataUtilsService.allDocs(t,e)}}]),e}();y.$inject=["$injector","pouchDB","angularNavDataUtilsService"];var p=function(){function e(t,a,i){n(this,e),this.cachedProducts=[],this.relevantIds=[],this.registeredOnCacheUpdatedCallbacks={},this.$q=t,this.productsService=a,this.utils=i;var r=this.relevant.bind(this,{bustCache:!0});this.productsService.callOnReplicationComplete("products-list-service",r)}return a(e,[{key:"registerOnCacheUpdatedCallback",value:function(e,t){this.registeredOnCacheUpdatedCallbacks[e]||(this.registeredOnCacheUpdatedCallbacks[e]=t)}},{key:"unregisterOnCacheUpdatedCallback",value:function(e){delete this.registeredOnCacheUpdatedCallbacks[e]}},{key:"queryAndUpdateCache",value:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=function(t){var n={include_docs:!0};if(t.onlyRelevant){if(!e.relevantIds.length)return e.$q.when([]);n.keys=e.relevantIds}else n.ascending=!0,n.startkey="product:",n.endkey="product:￿";return e.productsService.allDocs(n)},a=function(t){e.cachedProducts=t,e.cachedProducts.length&&e.utils.callEach(e.registeredOnCacheUpdatedCallbacks)};return n(t).then(a)}},{key:"relevant",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return e.onlyRelevant=!0,this.all(e)}},{key:"all",value:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=function(e,t){return t.storageType===e},a=function(){return t.byType?{dry:e.cachedProducts.filter(n.bind(null,"dry")),frozen:e.cachedProducts.filter(n.bind(null,"frozen"))}:e.cachedProducts};return this.cachedProducts.length&&!t.bustCache?this.$q.when(a()):this.queryAndUpdateCache(t).then(a)}},{key:"setRelevant",value:function(e){this.relevantIds=e,this.relevant({bustCache:!0})}}]),e}();p.$inject=["$q","productsService","angularNavDataUtilsService"];var g="angularNavData.products";e.module(g,[d,"pouchdb"]).service("productsService",y).service("productListService",p),e.module("angularNavData",[v,g])}(angular);