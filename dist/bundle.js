!function(e){"use strict";function t(e,t){return t={exports:{}},e(t,t.exports),t.exports}e="default"in e?e["default"]:e,!function(e){e="default"in e?e["default"]:e;var t={};t.classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},t.createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}();var n=function(e,t){var n=function(e){var t={key:e,isOptional:!1},n=e.split("?");return""===n[0]&&(t.key=n[1],t.isOptional=!0),t};return e.split(t).map(n)},a=function(){function e(n){t.classCallCheck(this,e);try{this.separator=n.get("ngSmartIdSeparator")}catch(a){this.separator=":"}try{this.patterns=n.get("ngSmartIdPatterns")}catch(a){this.patterns={}}}return t.createClass(e,[{key:"parse",value:function(e,t){var a=e.split(this.separator),i=void 0,r=a.reduce(function(e,t){return i?(e[i]=t,i=void 0):i=t,e},{});if(t){t=this.patterns[t]||t;var c=n(t,this.separator);c.forEach(function(e){if(!r[e.key]&&!e.isOptional)throw new Error("could not parse the id, non optional field "+e.key+" missing")})}return r}},{key:"idify",value:function(e,t){var a=this,i=function(e){return"undefined"!=typeof e&&null!==e&&""!==e};t=this.patterns[t]||t;var r=n(t,this.separator);return r.reduce(function(t,n){var r=e[n.key];if(r&&i(r))return t+(t.length?a.separator+n.key:n.key)+a.separator+r;if(!n.isOptional)throw new Error("could not generate id, missing field "+n.key);return t},"")}}]),e}();a.$inject=["$injector"],e.module("ngSmartId",[]).service("smartId",a)}(angular);var n=(t(function(e,t){"undefined"!=typeof e&&"undefined"!=typeof t&&e.exports===t&&(e.exports="pouchdb"),function(e,t,n){t.module("pouchdb",[]).constant("POUCHDB_METHODS",{destroy:"qify",put:"qify",post:"qify",get:"qify",remove:"qify",bulkDocs:"qify",bulkGet:"qify",allDocs:"qify",putAttachment:"qify",getAttachment:"qify",removeAttachment:"qify",query:"qify",viewCleanup:"qify",info:"qify",compact:"qify",revsDiff:"qify",changes:"eventEmitter",sync:"eventEmitter",replicate:{to:"eventEmitter",from:"eventEmitter"}}).service("pouchDBDecorators",["$q",function(e){this.qify=function(t){return function(){return e.when(t.apply(this,arguments))}},this.eventEmitter=function(t){return function(){var n=e.defer(),a=t.apply(this,arguments).on("change",function(e){return n.notify({change:e})}).on("paused",function(e){return n.notify({paused:e})}).on("active",function(e){return n.notify({active:e})}).on("denied",function(e){return n.notify({denied:e})}).on("complete",function(e){return n.resolve(e)}).on("error",function(e){return n.reject(e)});return a.$promise=n.promise,a}}}]).provider("pouchDB",["POUCHDB_METHODS",function(e){var n=this;n.methods=e,n.$get=["$window","pouchDBDecorators",function(e,a){function i(e,n,r){for(var c in n){var s=n[c];t.isString(s)?(s=a[s],r?e[r][c]=s(e[r][c]):e[c]=s(e[c])):i(e,s,c)}return e}return function(t,a){var r=new e.PouchDB(t,a);return i(r,n.methods)}}]}])}(window,window.angular)}),function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}),a=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),i=function(e,t){e.then(t)},r=function(){function e(t,a,i){n(this,e);var r=void 0;try{r=t.get("dataModuleRemoteDB")}catch(c){throw new Error("dataModuleRemoteDB should be provided in the data module configuration")}this.pouchDB=a,this.angularNavDataUtilsService=i,this.remoteDB=this.pouchDB(r),this.replicationFrom,this.localDB,this.registeredOnReplicationCompleteCallbackIds=[],this.callbacksPendingRegistration=[]}return a(e,[{key:"startReplication",value:function(e,t){var n={filter:"locations/by-state",query_params:{zone:e,state:t}};for(this.localDB=this.pouchDB("navIntLocationsDB"),this.replicationFrom=this.localDB.replicate.from(this.remoteDB,n);this.callbacksPendingRegistration.length;){var a=this.callbacksPendingRegistration.shift();i(this.replicationFrom,a)}}},{key:"callOnReplicationComplete",value:function(e,t){-1===this.registeredOnReplicationCompleteCallbackIds.indexOf(e)&&(this.registeredOnReplicationCompleteCallbackIds.push(e),this.replicationFrom?i(this.replicationFrom,t):this.callbacksPendingRegistration.push(t))}},{key:"allDocs",value:function(e){var t=this.localDB||this.remoteDB;return this.angularNavDataUtilsService.allDocs(t,e)}},{key:"get",value:function(e){var t=this.localDB||this.remoteDB;return t.get(e)}}]),e}();r.$inject=["$injector","pouchDB","angularNavDataUtilsService"];var c=function(){function e(t,a,i,r,c){n(this,e),this.cachedLgasByState={},this.cachedLgaIdsByState={},this.defaultZone,this.defaultState,this.registeredOnCacheUpdatedCallbacks={},this.$q=t,this.smartId=a,this.locationsService=i,this.statesService=r,this.productListService=c,this.locationsService.callOnReplicationComplete("lgas-service",this.onReplicationComplete.bind(this))}return a(e,[{key:"registerOnCacheUpdatedCallback",value:function(e,t){this.registeredOnCacheUpdatedCallbacks[e]||(this.registeredOnCacheUpdatedCallbacks[e]=t)}},{key:"unregisterOnCacheUpdatedCallback",value:function(e){delete this.registeredOnCacheUpdatedCallbacks[e]}},{key:"onCacheUpdated",value:function(){var e=this;Object.keys(this.registeredOnCacheUpdatedCallbacks).forEach(function(t){e.registeredOnCacheUpdatedCallbacks[t]()})}},{key:"onReplicationComplete",value:function(){this.bustCaches()}},{key:"bustCaches",value:function(){this.byState(null,null,{bustCache:!0}),this.setDefaultStateRelevantProducts()}},{key:"setDefaultStateRelevantProducts",value:function(){var e=this,t=function(t){e.productListService.setRelevant(t.products)},n="configuration:"+this.smartId.idify({zone:this.defaultZone,state:this.defaultState},"zone:state");this.locationsService.get(n).then(t)}},{key:"queryAndUpdateCache",value:function(e,t){var n=this,a=function(e){return e.id},i=function(e){return e.id=n.smartId.parse(e._id).lga,e},r=function(e,t){var a={include_docs:!0,ascending:!0,startkey:"zone:"+e+":state:"+t+":",endkey:"zone:"+e+":state:"+t+":￿"};return n.locationsService.allDocs(a)},c=function(e,t){n.cachedLgasByState[e]=t.map(i),n.cachedLgaIdsByState[e]=n.cachedLgasByState[e].map(a),n.cachedLgasByState[e].length&&n.onCacheUpdated()};return r(e,t).then(c.bind(null,t))}},{key:"byState",value:function(){var e=arguments.length<=0||void 0===arguments[0]?this.defaultZone:arguments[0],t=arguments.length<=1||void 0===arguments[1]?this.defaultState:arguments[1],n=arguments.length<=2||void 0===arguments[2]?{}:arguments[2];return n.bustCache||!this.cachedLgasByState[t]?this.queryAndUpdateCache(e,t).then(function(){return this.cachedLgasByState[t]}.bind(this)):this.$q.when(this.cachedLgasByState[t])}},{key:"idsByState",value:function(){var e=arguments.length<=0||void 0===arguments[0]?this.defaultZone:arguments[0],t=arguments.length<=1||void 0===arguments[1]?this.defaultState:arguments[1],n=arguments.length<=2||void 0===arguments[2]?{}:arguments[2];return n.bustCache||!this.cachedLgasByState[t]?this.queryAndUpdateCache(e,t).then(function(){return this.cachedLgaIdsByState[t]}.bind(this)):this.$q.when(this.cachedLgaIdsByState[t])}},{key:"setState",value:function(e,t){this.defaultZone=e,this.defaultState=t,this.statesService.setZone(this.defaultZone),this.bustCaches()}},{key:"get",value:function(e){var t=function(t){var n=!0,a=!1,i=void 0;try{for(var r,c=t[Symbol.iterator]();!(n=(r=c.next()).done);n=!0){var s=r.value;if(s._id===e)return s}}catch(o){a=!0,i=o}finally{try{!n&&c["return"]&&c["return"]()}finally{if(a)throw i}}},n=this.smartId.parse(e).state,a=this.smartId.parse(e).zone;return this.byState(a,n).then(t)}}]),e}();c.$inject=["$q","smartId","locationsService","statesService","productListService"];var s=function(){function e(t,a,i){n(this,e),this.cachedStatesByZone={},this.cachedStateIdsByZone={},this.defaultZone,this.registeredOnCacheUpdatedCallbacks={},this.$q=t,this.smartId=a,this.locationsService=i,this.locationsService.callOnReplicationComplete("states-service",this.onReplicationComplete.bind(this))}return a(e,[{key:"registerOnCacheUpdatedCallback",value:function(e,t){this.registeredOnCacheUpdatedCallbacks[e]||(this.registeredOnCacheUpdatedCallbacks[e]=t)}},{key:"unregisterOnCacheUpdatedCallback",value:function(e){delete this.registeredOnCacheUpdatedCallbacks[e]}},{key:"onCacheUpdated",value:function(){var e=this;Object.keys(this.registeredOnCacheUpdatedCallbacks).forEach(function(t){e.registeredOnCacheUpdatedCallbacks[t]()})}},{key:"onReplicationComplete",value:function(){this.byZone(null,{bustCache:!0})}},{key:"queryAndUpdateCache",value:function(e){var t=this,n=function(e){return e.id},a=function(e){return e.id=t.smartId.parse(e._id).state,e},i=function(e){return e.filter(function(e){return"state"===e.level})},r=function(e){var n={include_docs:!0,ascending:!0,startkey:"zone:"+e+":",endkey:"zone:"+e+":￿"};return t.locationsService.allDocs(n).then(i)},c=function(e,i){t.cachedStatesByZone[e]=i.map(a),t.cachedStateIdsByZone[e]=t.cachedStatesByZone[e].map(n),t.cachedStatesByZone[e].length&&t.onCacheUpdated()};return r(e).then(c.bind(null,e))}},{key:"byZone",value:function(){var e=arguments.length<=0||void 0===arguments[0]?this.defaultZone:arguments[0],t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return t.bustCache||!this.cachedStatesByZone[e]?this.queryAndUpdateCache(e).then(function(){return this.cachedStatesByZone[e]}.bind(this)):this.$q.when(this.cachedStatesByZone[e])}},{key:"idsByZone",value:function(){var e=arguments.length<=0||void 0===arguments[0]?this.defaultZone:arguments[0],t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return t.bustCache||!this.cachedStatesByZone[e]?this.queryAndUpdateCache(e).then(function(){return this.cachedStateIdsByZone[e]}.bind(this)):this.$q.when(this.cachedStateIdsByZone[e])}},{key:"setZone",value:function(e){this.defaultZone=e,this.byZone(null,{bustCache:!0})}},{key:"get",value:function(e){var t=function(t){var n=!0,a=!1,i=void 0;try{for(var r,c=t[Symbol.iterator]();!(n=(r=c.next()).done);n=!0){var s=r.value;if(s._id===e)return s}}catch(o){a=!0,i=o}finally{try{!n&&c["return"]&&c["return"]()}finally{if(a)throw i}}},n=this.smartId.parse(e).zone;return this.byZone(n).then(t)}}]),e}();s.$inject=["$q","smartId","locationsService"];var o=function(e){return e.doc},l=function(e){return e.rows.map(o)},u=function(){function e(){n(this,e)}return a(e,[{key:"allDocs",value:function(e,t){return e.allDocs(t).then(l)}}]),e}(),h="angularNavData.utils";e.module(h,[]).service("angularNavDataUtilsService",u);var d="angularNavData.locations";e.module(d,[h,"ngSmartId","pouchdb"]).service("locationsService",r).service("lgasService",c).service("statesService",s);var f=function(e,t){e.then(t)},v=function(){function e(t,a,i){n(this,e);var r=void 0;try{r=t.get("dataModuleRemoteDB")}catch(c){throw new Error("dataModuleRemoteDB should be provided in the data module configuration")}this.pouchDB=a,this.angularNavDataUtilsService=i,this.remoteDB=this.pouchDB(r),this.replicationFrom,this.localDB,this.registeredOnReplicationCompleteCallbackIds=[],this.callbacksPendingRegistration=[]}return a(e,[{key:"startReplication",value:function(e,t){var n={filter:"products/all"};for(this.localDB=this.pouchDB("navIntProductsDB"),this.replicationFrom=this.localDB.replicate.from(this.remoteDB,n);this.callbacksPendingRegistration.length;){var a=this.callbacksPendingRegistration.shift();f(this.replicationFrom,a)}}},{key:"callOnReplicationComplete",value:function(e,t){-1===this.registeredOnReplicationCompleteCallbackIds.indexOf(e)&&(this.registeredOnReplicationCompleteCallbackIds.push(e),this.replicationFrom?f(this.replicationFrom,t):this.callbacksPendingRegistration.push(t))}},{key:"allDocs",value:function(e){var t=this.localDB||this.remoteDB;return this.angularNavDataUtilsService.allDocs(t,e)}}]),e}();v.$inject=["$injector","pouchDB","angularNavDataUtilsService"];var p=function(){function e(t,a){n(this,e),this.cachedProducts=[],this.cachedDryProducts=[],this.cachedFrozenProducts=[],this.relevant=[],this.registeredOnCacheUpdatedCallbacks={},this.$q=t,this.productsService=a,this.productsService.callOnReplicationComplete("products-list-service",this.onReplicationComplete.bind(this))}return a(e,[{key:"registerOnCacheUpdatedCallback",value:function(e,t){this.registeredOnCacheUpdatedCallbacks[e]||(this.registeredOnCacheUpdatedCallbacks[e]=t)}},{key:"unregisterOnCacheUpdatedCallback",value:function(e){delete this.registeredOnCacheUpdatedCallbacks[e]}},{key:"onCacheUpdated",value:function(){var e=this;Object.keys(this.registeredOnCacheUpdatedCallbacks).forEach(function(t){e.registeredOnCacheUpdatedCallbacks[t]()})}},{key:"onReplicationComplete",value:function(){this.all({onlyRelevant:!0,bustCache:!0})}},{key:"queryAndUpdateCache",value:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=function(t){var n={include_docs:!0};if(t.onlyRelevant){if(!e.relevant.length)return e.$q.when([]);n.keys=e.relevant}else n.ascending=!0,n.startkey="product:",n.endkey="product:￿";return e.productsService.allDocs(n)},a=function(e){return"dry"===e.storageType},i=function(e){return"frozen"===e.storageType},r=function(e){return"undefined"!=typeof e},c=function(t){e.cachedProducts=t.filter(r),e.cachedDryProducts=e.cachedProducts.filter(a),e.cachedFrozenProducts=e.cachedProducts.filter(i),e.cachedProducts.length&&e.onCacheUpdated()};return n(t).then(c)}},{key:"all",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return e.bustCache||!this.cachedProducts.length>0?this.queryAndUpdateCache(e).then(function(){return this.cachedProducts}.bind(this)):this.$q.when(this.cachedProducts)}},{key:"dry",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return e.bustCache||!this.cachedProducts.length>0?this.queryAndUpdateCache(e).then(function(){return this.cachedDryProducts}.bind(this)):this.$q.when(this.cachedDryProducts)}},{key:"frozen",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return e.bustCache||!this.cachedProducts.length>0?this.queryAndUpdateCache(e).then(function(){return this.cachedFrozenProducts}.bind(this)):this.$q.when(this.cachedFrozenProducts)}},{key:"setRelevant",value:function(e){this.relevant=e,this.all({onlyRelevant:!0,bustCache:!0})}}]),e}();p.$inject=["$q","productsService"];var y="angularNavData.products";e.module(y,[h,"pouchdb"]).service("productsService",v).service("productListService",p),e.module("angularNavData",[d,y])}(angular);